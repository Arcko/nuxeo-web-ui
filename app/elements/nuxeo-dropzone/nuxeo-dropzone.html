<!--
(C) Copyright 2016 Nuxeo SA (http://nuxeo.com/) and others.

icensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Contributors:
  Gabriel Barata <gbarata@nuxeo.com>
-->

<!--
`nuxeo-dropzone`
@group Nuxeo UI
@element nuxeo-dropzone
-->
<dom-module id="nuxeo-dropzone">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        width: 100%;
        height: calc(100% - 40px);
      }

      #dropzone {
        display: flex;
        position: absolute;
        width: calc(100% + 20px);
        height: calc(100%);
        left: -10px;
        top: -10px;
        visibility: hidden;
      }

      #dropzone.visible {
        visibility: visible;
        cursor: pointer;
      }

      #dzContainer {
        position: relative;
        margin: var(--nuxeo-dropzone-border-margin, 16px);
        pointer-events: none;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-flex);
        @apply(--layout-center-justified);
      }

      #dzContainer.hover {
        border: 2px dashed #aaa;
        border-radius: 8px;
        @apply(--nuxeo-dropzone-hover-layout);
      }

      #dzContainer.hover-highlight {
        border: 2px dashed #555;
        border-radius: 8px;
        @apply(--nuxeo-dropzone-hover-layout);
      }

      #dzLabel {
        pointer-events: none;
        color: #aaa;
        text-align: center;
        margin: 8px;
      }

      #dzLabel.highlight {
        pointer-events: none;
        color: #555;
        text-align: center;
      }

      #content {
        position: relative;
        left: -10px;
        top: -10px;
        right: -10px;
        bottom: -10px;
        padding: 10px;
        width: 100%;
      }

      #content.hover {
        filter: brightness(30%);
        -webkit-filter: brightness(30%);
        @apply(--nuxeo-dropzone-content-fade-layout);
      }

      #innerContent.invisible {
        visibility: hidden;
        display: none;
      }

      #emptydz {
        min-height: var(--nuxeo-dropzone-min-empty-height, 300px);
      }
    </style>

    <nuxeo-connection id="nx"></nuxeo-connection>
    <nuxeo-document id="doc" doc-id="[[document.uid]]" data="{{document}}"></nuxeo-document>

    <paper-toast id="toast"></paper-toast>
    <div id="content">
      <div id="innerContent">
        <content></content>
      </div>
      <div hidden$="[[!empty]]">
        <input hidden id="input" type="file" on-change="_filesChanged">
        <div id="emptydz"></div>
      </div>
    </div>
    <div id="dropzone">
      <div id="dzContainer">
        <div id="dzLabel">
          <template is="dom-if" if="[[!progress]]">
            <template is="dom-if" if="[[dropping]]">
              [[message]]
            </template>
            <template is="dom-if" if="[[!dropping]]">
              [[messageEmpty]]
            </template>
          </template>
          <template is="dom-if" if="[[progress]]">
            [[progressMessage]]
          </template>
        </div>
        <template is="dom-if" if="[[progress]]">
          <paper-progress indeterminate></paper-progress>
        </template>
      </div>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'nuxeo-dropzone',
        behaviors: [Nuxeo.UploaderBehavior],
        properties: {
          document: {
            type: Object,
            notify: true
          },
          empty: {
            type: Boolean,
            value: false
          },
          dropping: {
            type: Boolean,
            value: false
          },
          message: {
            type: String
          },
          messageEmpty: {
            type: String
          },
          blobList: {
            type: Boolean,
            value: false
          },
          xpath: {
            type: String,
            value: 'file:content'
          },
          uploadedMessage: {
            type: String,
            value: 'File uploaded'
          },
          progressMessage: {
            type: String,
            value: 'In progress...'
          },
          progress: {
            type: Boolean,
            value: false
          }
        },
        listeners: {
          'batchFinished': 'importBatch',
          'content.dragenter': '_showOverlay'
        },
        observers: ['_observeEmpty(empty)'],

        ready: function() {
          this.connection = this.$.nx;
          this.setupDropZone(this.$.dropzone);
        },

        open: function() {
          this.$$('input').click();
        },

        importBatch: function(data) {
          data.stopPropagation();
          if (this.blobList) {
            this.batchExecute('BlobHolder.AttachOnCurrentDocument', {
              useMainBlob: false,
              context: {
                currentDocument: this.document.path
              }
            }).then(function() {
              return this.$.doc.get().then(function(response) {
                this.document.properties[this.xpath] = response.properties[this.xpath];
                this.notifyPath('document.properties.' + this.xpath, this.document.properties[this.xpath]);
                this._toast(this.uploadedMessage);
                this.progress = false;
              }.bind(this));
            }.bind(this));
          } else {
            this.document.properties[this.xpath] = {
              'upload-batch': data.detail.batchId,
              'upload-fileId': '0'
            };
            this.$.doc.put().then(function(response) {
              this.document = response;
              this._toast(this.uploadedMessage);
              this.progress = false;
            }.bind(this));
          }
        },

        _filesChanged: function(e) {
          this._upload(e.target.files);
        },

        _observeEmpty: function() {
          if (!this.handleDlClick) {
            this.handleDlClick = function handleDlClick() {
              this.$$('input').click();
            }.bind(this);
          }
          if (this.empty) {
            this.toggleClass('hover', true, this.$.dzContainer);
            this.toggleClass('visible', true, this.$.dropzone);
            this.toggleClass('invisible', true, this.$.innerContent);
            this.$.dropzone.addEventListener('click', this.handleDlClick);
          } else {
            this.$.dropzone.removeEventListener('click', this.handleDlClick);
            this.toggleClass('hover', false, this.$.dzContainer);
            this.toggleClass('visible', false, this.$.dropzone);
            this.toggleClass('invisible', false, this.$.innerContent);
          }
          Polymer.dom.flush();
        },

        _toast: function(msg) {
          this.$.toast.text = msg;
          this.$.toast.open();
        },

        _showOverlay: function() {
          if (!this.empty) {
            this.toggleClass('visible', true, this.$.dropzone);
          }
        },

        _dragover: function(e) {
          e.preventDefault();
          this.dropping = true;
          if (!this.empty) {
            this.toggleClass('hover', true, this.$.dzContainer);
            this.toggleClass('hover', true, this.$.content);
          } else {
            this.toggleClass('hover-highlight', true, this.$.dzContainer);
            this.toggleClass('highlight', true, this.$.dzLabel);
          }
        },

        _dragleave: function() {
          this.dropping = false;
          if (!this.empty) {
            this.toggleClass('hover', false, this.$.dzContainer);
            this.toggleClass('visible', false, this.$.dropzone);
            this.toggleClass('hover', false, this.$.content);
          } else {
            this.toggleClass('hover-highlight', false, this.$.dzContainer);
            this.toggleClass('highlight', false, this.$.dzLabel);
          }
        },

        _drop: function(e) {
          this.progress = true;
          this.dropping = false;
          if (!this.empty) {
            this.toggleClass('hover', false, this.$.dzContainer);
            this.toggleClass('visible', false, this.$.dropzone);
            this.toggleClass('hover', false, this.$.content);
          } else {
            this.toggleClass('hover-highlight', false, this.$.dzContainer);
            this.toggleClass('highlight', false, this.$.dzLabel);
          }
          e.preventDefault();
          this._upload(e.dataTransfer.files);
        },

        _upload: function(files) {
          if (files && files.length > 0) {
            this.empty = true;
            this.progress = true;
            this.uploadFiles(files);
          }
        }
      });
    })();
  </script>

</dom-module>
